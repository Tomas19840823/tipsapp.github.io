<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Tip Your Waiter | Tipsy</title>
    <style>
        body { font-family: 'Segoe UI', sans-serif; background-color: #f5f7fa; display: flex; justify-content: center; align-items: center; height: 100vh; margin: 0; }
        .card { background: white; width: 100%; max-width: 400px; padding: 30px; border-radius: 20px; box-shadow: 0 4px 15px rgba(0,0,0,0.1); text-align: center; }
        .avatar { width: 100px; height: 100px; border-radius: 50%; object-fit: cover; border: 4px solid #FF9800; margin-bottom: 15px; }
        h2 { margin: 10px 0 5px; color: #333; }
        p { color: #777; margin-bottom: 30px; }
        .input-group { margin-bottom: 25px; }
        input[type="number"] { font-size: 2em; width: 120px; text-align: center; border: none; border-bottom: 2px solid #FF9800; color: #FF5722; font-weight: bold; outline: none; }
        .btn { background: linear-gradient(to right, #FF9800, #FF5722); color: white; border: none; padding: 15px; width: 100%; border-radius: 30px; font-size: 1.2em; font-weight: bold; cursor: pointer; transition: transform 0.1s; }
        .btn:active { transform: scale(0.98); }
        .hidden { display: none; }
    </style>
</head>
<body>

<div class="card" id="loading">
    <h3>Loading Waiter Profile...</h3>
</div>

<div class="card hidden" id="payment-card">
    <img id="waiter-img" src="" class="avatar" alt="Waiter">
    <h2 id="waiter-name">Waiter Name</h2>
    <p id="restaurant-name">Restaurant</p>

    <div class="input-group">
        <span style="font-size: 2em; color: #FF5722;">â‚¬</span>
        <input type="number" id="amount" value="5.00" step="0.50" min="0.50">
    </div>

    <button class="btn" onclick="initiatePayment()">Pay with Bank</button>
</div>

<div class="card hidden" id="error-card">
    <h3 style="color: red;">Waiter Not Found</h3>
    <p>Please scan a valid QR code.</p>
</div>

<script>
    const API_BASE = "https://api.tipsy.lt/api"; // Your Hetzner IP

    // 1. Get ID from URL (e.g., tipsy.lt/pay?id=55)
    const urlParams = new URLSearchParams(window.location.search);
    const waiterId = urlParams.get('id');

    if (waiterId) {
        fetchWaiter(waiterId);
    } else {
        showError();
    }

    async function fetchWaiter(id) {
        try {
            const response = await fetch(`${API_BASE}/waiter/${id}`);
            if (!response.ok) throw new Error("Not Found");
            
            const waiter = await response.json();
            
            // Fill UI
            document.getElementById('waiter-name').innerText = waiter.name;
            document.getElementById('restaurant-name').innerText = waiter.restaurantId || "Unknown Location";
            if(waiter.imageUrl) {
                document.getElementById('waiter-img').src = waiter.imageUrl;
            } else {
                // Fallback image
                document.getElementById('waiter-img').src = "https://cdn-icons-png.flaticon.com/512/847/847969.png"; 
            }

            document.getElementById('loading').classList.add('hidden');
            document.getElementById('payment-card').classList.remove('hidden');

        } catch (e) {
            showError();
        }
    }

    function showError() {
        document.getElementById('loading').classList.add('hidden');
        document.getElementById('error-card').classList.remove('hidden');
    }

    async function initiatePayment() {
        const amount = document.getElementById('amount').value;
        const amountCents = Math.round(parseFloat(amount) * 100);

        if (amountCents <= 0) { alert("Please enter a valid amount"); return; }

        try {
            const response = await fetch(`${API_BASE}/payment/initiate-simple`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({
                    sender_id: 0, // Guest
                    waiter_id: waiterId,
                    amount: amountCents
                })
            });

            const data = await response.json();
            if (data.success && data.payment_url) {
                window.location.href = data.payment_url; // Redirect to Bank
            } else {
                alert("Payment Error: " + (data.error || "Unknown"));
            }
        } catch (e) {
            alert("Connection Failed");
        }
    }
</script>

</body>
</html>
